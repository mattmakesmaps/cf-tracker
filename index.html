<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>CF-Tracker</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'/>
    <script type='text/javascript' src='js/jquery-2.1.1.min.js'></script>
    <script type='text/javascript' src='js/tabletop.js'></script>
    <script type='text/javascript' src='js/sheetsee.js'></script>
    <link rel='stylesheet' type='text/css' href='css/sss.css'>
  </head>

  <style>
    input {
        border: none;
        border-bottom: 1px solid #333;
        margin: 10px 0px;
        width: 200px;
        font-size: 16px;
        padding-bottom: 6px;
    }
  </style>

  <body>
      <div class="container">
        <h2>Weight Over Time</h2>
        <div id="lineChart"></div>
        <h2>Data Table</h2>
        <input id="fullTableFilter" type="text" placeholder="filter by..">
        <div id="fullTable"></div>
        <h2>Movement Stats</h2>
        <div id="statsDisplay"></div>
          <h2>Movement Notes</h2>
          <div id="notesDisplay"></div>
      </div>

      <script id="notesDisplay" type="text/html">
          <ul>
          {{#rows}}
              {{#notes}}
              <li>{{notes}}</li>
              {{/notes}}
          {{/rows}}
          </ul>
      </script>

    <script id="statsDisplay" type="text/html">
        <ul>
            <li><b>Max Weight:</b> {{max}}</li>
            <li><b>Number of Entries:</b> {{count}}</li>
        </ul>
    </script>

    <script id="fullTable" type="text/html">
      <table>
        <tr>
            <th class="tHeader">Date</th>
            <th class="tHeader">Movement</th>
            <th class="tHeader">Weight (KG)</th>
            <th class="tHeader">Reps</th>
        </tr>
          {{#rows}}
            <tr>
                <td>{{date}}</td>
                <td>{{movement}}</td>
                <td>{{weight}}</td>
                <td>{{reps}}</td>
            </tr>
          {{/rows}}
      </table>
    </script>

<script type="text/javascript">
  // Using jQuery DOM Ready Format
  $(document).ready(function(){
      var URL = "13C8ZxRoVam5a7fYddnlCmRinc3U7j8gaLHgs6ElkGnQ";
      Tabletop.init(
              {
                  key: URL,
                  callback: showInfo,
                  simpleSheet: true,
                  parseNumbers: true,
                  postProcess: function(element) {
                      element["timestamp"] = Date.parse(element["date"])
                  }
              }
      );
  });

  function showInfo(data) {
      // Populate the Data Table
      var tableOptions = {
          "data": data,
          "pagination": 10,
          "tableDiv": "#fullTable",
          "filterDiv": "#fullTableFilter"
      };
      Sheetsee.makeTable(tableOptions);
      Sheetsee.initiateTableFilter(tableOptions);

      // Create the Initial Line Chart
      var lineOptions = {
          labels: "timestamp",
          units: "weight",
          m: [50, 50, 50, 50],
          w: 600,
          h: 300,
          div: "#lineChart",
          hiColor: "#14ECC8"};

      // User Clicks a Table Cell
      var fullTable = document.getElementById("fullTable");
      fullTable.addEventListener("click", function(evt){
          // For a click on any cell in row, get the movement name.
          var selected_movement = evt.target.parentNode.children[1].innerHTML;
          // All records for the movement a user clicked.
          var clicked_data = Sheetsee.getMatches(data, selected_movement, "movement");

          // Update the chart
          $('#lineChart').empty();
          Sheetsee.d3LineChart(clicked_data, lineOptions);

          // Update Notes List. Note we're using ich built with
          // Sheetsee, as opposed to a separate ich lib.
          var notes_html;
          notes_html = Sheetsee.ich.notesDisplay({
              rows: clicked_data
          });
          $('#notesDisplay').html(notes_html);

          // Update Stats List
          var stats_html;
          var max_weight;
          if (clicked_data[0]) {
              max_weight = Sheetsee.getMax(clicked_data, "weight")[0]["weight"] || "No Data (Empty String)";
          }
          else {
              max_weight = "No Data (No Property)";
          }
          stats_html = Sheetsee.ich.statsDisplay({
              max: max_weight,
              count: clicked_data.length
          });
          $('#statsDisplay').html(stats_html);
      }, false);

  }
</script>

</body>
</html>
